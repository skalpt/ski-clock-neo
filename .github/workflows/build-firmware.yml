name: Build and Release Firmware

on:
  push:
    branches:
      - main  # Automatically build on every push to main
  workflow_dispatch:  # Allows manual triggering from GitHub UI

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Arduino CLI
        uses: arduino/setup-arduino-cli@v1
        
      - name: Install ESP32 platform
        run: |
          arduino-cli core update-index
          arduino-cli core install esp32:esp32
          
      - name: Install ESP8266 platform
        run: |
          arduino-cli core update-index --additional-urls http://arduino.esp8266.com/stable/package_esp8266com_index.json
          arduino-cli core install esp8266:esp8266 --additional-urls http://arduino.esp8266.com/stable/package_esp8266com_index.json
          
      - name: Install required libraries
        run: |
          arduino-cli lib install "Adafruit NeoPixel"
          arduino-cli lib install "AutoConnect"
      
      - name: Generate timestamp version
        id: get_version
        run: |
          VERSION=$(date -u +'%Y.%-m.%-d').${{ github.run_number }}
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Generated version: $VERSION"
      
      - name: Create and upload config to dashboard
        run: |
          cat > config.json << EOF
          {
            "UPDATE_SERVER_URL": "${{ secrets.UPDATE_SERVER_URL }}",
            "UPLOAD_API_KEY": "${{ secrets.UPLOAD_API_KEY }}",
            "DOWNLOAD_API_KEY": "${{ secrets.DOWNLOAD_API_KEY }}"
          }
          EOF
          curl -X POST "${{ secrets.UPDATE_SERVER_URL }}/api/config" \
            -H "X-API-Key: ${{ secrets.UPLOAD_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d @config.json
          rm config.json
          
      - name: Build for ESP32
        run: |
          arduino-cli compile --fqbn esp32:esp32:esp32 \
            --build-property "build.partitions=min_spiffs" \
            --build-property "compiler.cpp.extra_flags=-DUPDATE_SERVER_URL=\"${{ secrets.UPDATE_SERVER_URL }}\" -DDOWNLOAD_API_KEY=\"${{ secrets.DOWNLOAD_API_KEY }}\" -DFIRMWARE_VERSION=\"${{ steps.get_version.outputs.VERSION }}\"" \
            --output-dir build/esp32 \
            firmware/
          cp build/esp32/ski-clock-neo.ino.bin build/ski-clock-neo-esp32.bin
          
      - name: Build for ESP8266
        run: |
          arduino-cli compile --fqbn esp8266:esp8266:nodemcuv2 \
            --build-property "build.flash_size=4M3M" \
            --build-property "compiler.cpp.extra_flags=-DUPDATE_SERVER_URL=\"${{ secrets.UPDATE_SERVER_URL }}\" -DDOWNLOAD_API_KEY=\"${{ secrets.DOWNLOAD_API_KEY }}\" -DFIRMWARE_VERSION=\"${{ steps.get_version.outputs.VERSION }}\"" \
            --output-dir build/esp8266 \
            firmware/
          cp build/esp8266/ski-clock-neo.ino.bin build/ski-clock-neo-esp8266.bin
        
      - name: Upload ESP32 firmware to server
        run: |
          curl -X POST "${{ secrets.UPDATE_SERVER_URL }}/api/upload" \
            -H "X-API-Key: ${{ secrets.UPLOAD_API_KEY }}" \
            -F "file=@build/ski-clock-neo-esp32.bin" \
            -F "version=${{ steps.get_version.outputs.VERSION }}" \
            -F "platform=esp32"
            
      - name: Upload ESP8266 firmware to server
        run: |
          curl -X POST "${{ secrets.UPDATE_SERVER_URL }}/api/upload" \
            -H "X-API-Key: ${{ secrets.UPLOAD_API_KEY }}" \
            -F "file=@build/ski-clock-neo-esp8266.bin" \
            -F "version=${{ steps.get_version.outputs.VERSION }}" \
            -F "platform=esp8266"
          
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: firmware-binaries-${{ steps.get_version.outputs.VERSION }}
          path: build/*.bin
