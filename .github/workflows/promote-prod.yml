name: Promote to Production

on:
  workflow_dispatch:
    inputs:
      dev_run_id:
        description: 'Dev build run ID to promote (optional, uses latest successful dev build if empty)'
        required: false
        type: string
      description:
        description: 'Build description override (optional, uses dev build description if empty)'
        required: false
        type: string

jobs:
  fetch-version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get_dev_version.outputs.VERSION }}
      git_sha: ${{ steps.get_dev_version.outputs.GIT_SHA }}
      dev_run_id: ${{ steps.get_dev_version.outputs.DEV_RUN_ID }}
      description: ${{ steps.get_dev_version.outputs.DESCRIPTION }}
    
    steps:
      - name: Fetch dev build version
        id: get_dev_version
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Check if a specific run ID was provided
          INPUT_RUN_ID="${{ inputs.dev_run_id }}"
          
          if [ -n "$INPUT_RUN_ID" ]; then
            echo "ðŸŽ¯ Using specified dev run ID: $INPUT_RUN_ID"
            
            # Fetch the specific run to get its details
            RUN_DATA=$(gh api \
              -H "Accept: application/vnd.github+json" \
              "/repos/${{ github.repository }}/actions/runs/$INPUT_RUN_ID")
            
            if [ -z "$RUN_DATA" ] || [ "$RUN_DATA" == "null" ]; then
              echo "âŒ Run ID $INPUT_RUN_ID not found!"
              exit 1
            fi
            
            RUN_ID="$INPUT_RUN_ID"
            GIT_SHA=$(echo "$RUN_DATA" | jq -r '.head_sha')
            CONCLUSION=$(echo "$RUN_DATA" | jq -r '.conclusion')
            
            if [ "$CONCLUSION" != "success" ]; then
              echo "âš ï¸ Warning: Run $RUN_ID has conclusion '$CONCLUSION' (not 'success')"
              echo "   Proceeding anyway since you explicitly specified this run..."
            fi
          else
            echo "ðŸ” Fetching latest successful dev build..."
            
            # Get the latest successful run of build-firmware.yml (the dev build workflow)
            LATEST_RUN=$(gh api \
              -H "Accept: application/vnd.github+json" \
              "/repos/${{ github.repository }}/actions/workflows/build-firmware.yml/runs?status=completed&per_page=10" \
              --jq '[.workflow_runs[] | select(.conclusion == "success")] | .[0]')
            
            if [ -z "$LATEST_RUN" ] || [ "$LATEST_RUN" == "null" ]; then
              echo "âŒ No successful dev builds found!"
              exit 1
            fi
            
            RUN_ID=$(echo "$LATEST_RUN" | jq -r '.id')
            GIT_SHA=$(echo "$LATEST_RUN" | jq -r '.head_sha')
          fi
          
          echo "ðŸ“¦ Using dev run ID: $RUN_ID"
          echo "ðŸ“¦ Git SHA: $GIT_SHA"
          
          # Download the promotion manifest artifact
          echo "ðŸ“¥ Downloading promotion manifest..."
          gh run download "$RUN_ID" -n promotion-manifest -D /tmp/manifest
          
          if [ ! -f /tmp/manifest/promotion-manifest.json ]; then
            echo "âŒ Promotion manifest not found in dev build artifacts!"
            exit 1
          fi
          
          VERSION=$(jq -r '.version' /tmp/manifest/promotion-manifest.json)
          DEV_DESCRIPTION=$(jq -r '.description // ""' /tmp/manifest/promotion-manifest.json)
          
          # Use input description if provided, otherwise use dev build description
          FINAL_DESCRIPTION="${{ inputs.description }}"
          if [ -z "$FINAL_DESCRIPTION" ]; then
            FINAL_DESCRIPTION="$DEV_DESCRIPTION"
          fi
          
          echo "âœ… Dev version to promote: $VERSION"
          if [ -n "$FINAL_DESCRIPTION" ]; then
            echo "ðŸ“ Description: $FINAL_DESCRIPTION"
          fi
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "GIT_SHA=$GIT_SHA" >> $GITHUB_OUTPUT
          echo "DEV_RUN_ID=$RUN_ID" >> $GITHUB_OUTPUT
          echo "DESCRIPTION=$FINAL_DESCRIPTION" >> $GITHUB_OUTPUT

      - name: Display promotion info
        run: |
          echo "## ðŸš€ Promoting Dev Build to Production" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          INPUT_RUN_ID="${{ inputs.dev_run_id }}"
          if [ -n "$INPUT_RUN_ID" ]; then
            echo "> ðŸŽ¯ **Using specified run ID** (override mode)" >> $GITHUB_STEP_SUMMARY
          else
            echo "> ðŸ“¦ **Using latest successful dev build** (default mode)" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Field | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Version** | \`${{ steps.get_dev_version.outputs.VERSION }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Git SHA** | \`${{ steps.get_dev_version.outputs.GIT_SHA }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Dev Run ID** | \`${{ steps.get_dev_version.outputs.DEV_RUN_ID }}\` |" >> $GITHUB_STEP_SUMMARY

  build-and-deploy-prod:
    needs: fetch-version
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code at dev build commit
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.fetch-version.outputs.git_sha }}

      - name: Display build info
        run: |
          echo "ðŸ”¨ Building production firmware"
          echo "   Version: ${{ needs.fetch-version.outputs.version }}"
          echo "   Git SHA: ${{ needs.fetch-version.outputs.git_sha }}"

      - name: Setup Arduino CLI
        uses: arduino/setup-arduino-cli@v1

      - name: Install ESP32 + ESP8266 platforms
        run: |
          retry() {
            local n=1
            local max=5
            local delay=5
            while true; do
              "$@" && break || {
                if [[ $n -lt $max ]]; then
                  ((n++))
                  echo "Command failed. Attempt $n/$max:"
                  sleep $delay
                else
                  echo "The command has failed after $n attempts."
                  return 1
                fi
              }
            done
          }
          
          retry arduino-cli core update-index
          retry arduino-cli core install esp32:esp32@2.0.14
          retry arduino-cli core update-index --additional-urls http://arduino.esp8266.com/stable/package_esp8266com_index.json
          retry arduino-cli core install esp8266:esp8266 --additional-urls http://arduino.esp8266.com/stable/package_esp8266com_index.json

      - name: Install required libraries
        run: |
          retry() {
            local n=1
            local max=5
            local delay=5
            while true; do
              "$@" && break || {
                if [[ $n -lt $max ]]; then
                  ((n++))
                  echo "Command failed. Attempt $n/$max:"
                  sleep $delay
                else
                  echo "The command has failed after $n attempts."
                  return 1
                fi
              }
            done
          }
          
          retry arduino-cli lib install "FastLED"
          retry arduino-cli lib install "AutoConnect"
          retry arduino-cli lib install "PubSubClient"
          retry arduino-cli lib install "OneWire"
          retry arduino-cli lib install "DallasTemperature"
          retry arduino-cli lib install "TickTwo"
          retry arduino-cli lib install "RTClib"

      - name: Upload config to production
        run: |
          cat > config.json << EOF
          {
            "UPDATE_SERVER_URL": "${{ secrets.UPDATE_SERVER_URL }}",
            "UPLOAD_API_KEY": "${{ secrets.UPLOAD_API_KEY }}",
            "DOWNLOAD_API_KEY": "${{ secrets.DOWNLOAD_API_KEY }}",
            "MQTT_HOST": "${{ secrets.MQTT_HOST }}",
            "MQTT_USERNAME": "${{ secrets.MQTT_USERNAME }}",
            "MQTT_PASSWORD": "${{ secrets.MQTT_PASSWORD }}"
          }
          EOF
          echo "ðŸš€ Uploading configuration to PRODUCTION..."
          curl --fail --show-error -X POST "${{ secrets.UPDATE_SERVER_URL }}/api/config" \
            -H "X-API-Key: ${{ secrets.UPLOAD_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d @config.json \
            -w "\n"
          echo "âœ“ Configuration uploaded to production successfully"
          rm config.json

      - name: Build for ESP32 (original)
        run: |
          arduino-cli compile --fqbn esp32:esp32:esp32 \
            --export-binaries \
            --build-property "build.partitions=min_spiffs" \
            --build-property "compiler.cpp.extra_flags=-DUPDATE_SERVER_URL=\"${{ secrets.UPDATE_SERVER_URL }}\" -DDOWNLOAD_API_KEY=\"${{ secrets.DOWNLOAD_API_KEY }}\" -DFIRMWARE_VERSION=\"${{ needs.fetch-version.outputs.version }}\" -DMQTT_HOST=\"${{ secrets.MQTT_HOST }}\" -DMQTT_USERNAME=\"${{ secrets.MQTT_USERNAME }}\" -DMQTT_PASSWORD=\"${{ secrets.MQTT_PASSWORD }}\" -DBOARD_ESP32 -DPENDING_ENV_SCOPE=2 -DRELEASE_BUILD" \
            --output-dir build/esp32 \
            firmware/ski-clock-neo
          cp build/esp32/ski-clock-neo.ino.bin build/ski-clock-neo-esp32.bin
          cp build/esp32/ski-clock-neo.ino.bootloader.bin build/ski-clock-neo-esp32.bootloader.bin || echo "Warning: Bootloader not found for ESP32"
          cp build/esp32/ski-clock-neo.ino.partitions.bin build/ski-clock-neo-esp32.partitions.bin || echo "Warning: Partitions not found for ESP32"

      - name: Build for ESP32-C3
        run: |
          arduino-cli compile --fqbn esp32:esp32:esp32c3:CDCOnBoot=cdc \
            --export-binaries \
            --build-property "build.partitions=min_spiffs" \
            --build-property "compiler.cpp.extra_flags=-DUPDATE_SERVER_URL=\"${{ secrets.UPDATE_SERVER_URL }}\" -DDOWNLOAD_API_KEY=\"${{ secrets.DOWNLOAD_API_KEY }}\" -DFIRMWARE_VERSION=\"${{ needs.fetch-version.outputs.version }}\" -DMQTT_HOST=\"${{ secrets.MQTT_HOST }}\" -DMQTT_USERNAME=\"${{ secrets.MQTT_USERNAME }}\" -DMQTT_PASSWORD=\"${{ secrets.MQTT_PASSWORD }}\" -DBOARD_ESP32C3 -DPENDING_ENV_SCOPE=2 -DRELEASE_BUILD" \
            --output-dir build/esp32c3 \
            firmware/ski-clock-neo
          cp build/esp32c3/ski-clock-neo.ino.bin build/ski-clock-neo-esp32c3.bin
          cp build/esp32c3/ski-clock-neo.ino.bootloader.bin build/ski-clock-neo-esp32c3.bootloader.bin || echo "Warning: Bootloader not found for ESP32-C3"
          cp build/esp32c3/ski-clock-neo.ino.partitions.bin build/ski-clock-neo-esp32c3.partitions.bin || echo "Warning: Partitions not found for ESP32-C3"

      - name: Build for ESP32-S3
        run: |
          arduino-cli compile --fqbn esp32:esp32:esp32s3:CDCOnBoot=cdc \
            --export-binaries \
            --build-property "build.partitions=min_spiffs" \
            --build-property "compiler.cpp.extra_flags=-DUPDATE_SERVER_URL=\"${{ secrets.UPDATE_SERVER_URL }}\" -DDOWNLOAD_API_KEY=\"${{ secrets.DOWNLOAD_API_KEY }}\" -DFIRMWARE_VERSION=\"${{ needs.fetch-version.outputs.version }}\" -DMQTT_HOST=\"${{ secrets.MQTT_HOST }}\" -DMQTT_USERNAME=\"${{ secrets.MQTT_USERNAME }}\" -DMQTT_PASSWORD=\"${{ secrets.MQTT_PASSWORD }}\" -DBOARD_ESP32S3 -DPENDING_ENV_SCOPE=2 -DRELEASE_BUILD" \
            --output-dir build/esp32s3 \
            firmware/ski-clock-neo
          cp build/esp32s3/ski-clock-neo.ino.bin build/ski-clock-neo-esp32s3.bin
          cp build/esp32s3/ski-clock-neo.ino.bootloader.bin build/ski-clock-neo-esp32s3.bootloader.bin || echo "Warning: Bootloader not found for ESP32-S3"
          cp build/esp32s3/ski-clock-neo.ino.partitions.bin build/ski-clock-neo-esp32s3.partitions.bin || echo "Warning: Partitions not found for ESP32-S3"

      - name: Build for ESP-12F
        run: |
          arduino-cli compile --fqbn esp8266:esp8266:generic:eesz=4M1M \
            --build-property "compiler.cpp.extra_flags=-DUPDATE_SERVER_URL=\"${{ secrets.UPDATE_SERVER_URL }}\" -DDOWNLOAD_API_KEY=\"${{ secrets.DOWNLOAD_API_KEY }}\" -DFIRMWARE_VERSION=\"${{ needs.fetch-version.outputs.version }}\" -DMQTT_HOST=\"${{ secrets.MQTT_HOST }}\" -DMQTT_USERNAME=\"${{ secrets.MQTT_USERNAME }}\" -DMQTT_PASSWORD=\"${{ secrets.MQTT_PASSWORD }}\" -DBOARD_ESP12F -DPENDING_ENV_SCOPE=2 -DRELEASE_BUILD" \
            --output-dir build/esp12f \
            firmware/ski-clock-neo
          cp build/esp12f/ski-clock-neo.ino.bin build/ski-clock-neo-esp12f.bin

      - name: Build for ESP-01 (1M)
        run: |
          arduino-cli compile --fqbn esp8266:esp8266:generic:eesz=1M \
            --build-property "compiler.cpp.extra_flags=-DUPDATE_SERVER_URL=\"${{ secrets.UPDATE_SERVER_URL }}\" -DDOWNLOAD_API_KEY=\"${{ secrets.DOWNLOAD_API_KEY }}\" -DFIRMWARE_VERSION=\"${{ needs.fetch-version.outputs.version }}\" -DMQTT_HOST=\"${{ secrets.MQTT_HOST }}\" -DMQTT_USERNAME=\"${{ secrets.MQTT_USERNAME }}\" -DMQTT_PASSWORD=\"${{ secrets.MQTT_PASSWORD }}\" -DBOARD_ESP01 -DPENDING_ENV_SCOPE=2 -DRELEASE_BUILD" \
            --output-dir build/esp01 \
            firmware/ski-clock-neo
          cp build/esp01/ski-clock-neo.ino.bin build/ski-clock-neo-esp01.bin

      - name: Build for Wemos D1 Mini
        run: |
          arduino-cli compile --fqbn esp8266:esp8266:d1_mini:eesz=4M1M \
            --build-property "compiler.cpp.extra_flags=-DUPDATE_SERVER_URL=\"${{ secrets.UPDATE_SERVER_URL }}\" -DDOWNLOAD_API_KEY=\"${{ secrets.DOWNLOAD_API_KEY }}\" -DFIRMWARE_VERSION=\"${{ needs.fetch-version.outputs.version }}\" -DMQTT_HOST=\"${{ secrets.MQTT_HOST }}\" -DMQTT_USERNAME=\"${{ secrets.MQTT_USERNAME }}\" -DMQTT_PASSWORD=\"${{ secrets.MQTT_PASSWORD }}\" -DBOARD_WEMOS_D1MINI -DPENDING_ENV_SCOPE=2 -DRELEASE_BUILD" \
            --output-dir build/d1mini \
            firmware/ski-clock-neo
          cp build/d1mini/ski-clock-neo.ino.bin build/ski-clock-neo-d1mini.bin

      - name: Upload firmware to PRODUCTION
        if: success()
        run: |
          echo "ðŸš€ DEPLOYING TO PRODUCTION"
          
          # Build description (from dev build or override)
          DESCRIPTION="${{ needs.fetch-version.outputs.description }}"
          
          for file in build/ski-clock-neo-*.bin; do
            if [[ "$file" == *".bootloader.bin" ]] || [[ "$file" == *".partitions.bin" ]]; then
              continue
            fi

            PLATFORM=$(basename "$file" .bin | sed 's/ski-clock-neo-//')
            echo "Uploading $file to PRODUCTION (platform=$PLATFORM version=${{ needs.fetch-version.outputs.version }})..."

            BOOTLOADER="build/ski-clock-neo-${PLATFORM}.bootloader.bin"
            PARTITIONS="build/ski-clock-neo-${PLATFORM}.partitions.bin"

            # Build common form fields
            COMMON_FIELDS="-F version=${{ needs.fetch-version.outputs.version }} -F platform=$PLATFORM -F product=ski-clock-neo"
            if [ -n "$DESCRIPTION" ]; then
              COMMON_FIELDS="$COMMON_FIELDS -F description=$DESCRIPTION"
            fi

            if [ -f "$BOOTLOADER" ] && [ -f "$PARTITIONS" ]; then
              echo "  â†’ Full flash mode: uploading firmware, bootloader, and partitions"
              curl --fail --show-error \
                -X POST "${{ secrets.UPDATE_SERVER_URL }}/api/upload" \
                -H "X-API-Key: ${{ secrets.UPLOAD_API_KEY }}" \
                -F "file=@$file" \
                -F "bootloader=@$BOOTLOADER" \
                -F "partitions=@$PARTITIONS" \
                $COMMON_FIELDS \
                -w "\n"
            else
              echo "  â†’ Quick flash mode: uploading firmware only"
              curl --fail --show-error \
                -X POST "${{ secrets.UPDATE_SERVER_URL }}/api/upload" \
                -H "X-API-Key: ${{ secrets.UPLOAD_API_KEY }}" \
                -F "file=@$file" \
                $COMMON_FIELDS \
                -w "\n"
            fi

            echo "âœ“ Upload for platform '$PLATFORM' to production succeeded"
          done

      - name: Upload build artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: firmware-binaries-prod-${{ needs.fetch-version.outputs.version }}
          path: build/*.bin

      - name: Job Summary
        if: success()
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## âœ… Production Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Field | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Version** | \`${{ needs.fetch-version.outputs.version }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Environment** | \`prod\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Source Git SHA** | \`${{ needs.fetch-version.outputs.git_sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Dev Run ID** | \`${{ needs.fetch-version.outputs.dev_run_id }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŽ‰ All 6 board variants deployed to production with version \`${{ needs.fetch-version.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
