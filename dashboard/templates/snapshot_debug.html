{% extends "base.html" %}

{% block title %}Display Snapshot Debug - Ski Clock Neo{% endblock %}

{% block content %}
<div class="container">
    <div class="header-bar">
        <div class="header-content">
            <h1>‚õ∑Ô∏è Ski Clock Neo</h1>
            <p class="subtitle">Display Snapshot Debugger</p>
        </div>
        <a href="/" class="back-link">‚Üê Back to Dashboard</a>
    </div>

    <div class="card">
        <h2>üîç Snapshot History (Row Text vs Bitmap)</h2>
        <p class="description-text">
            Compare what text the device sent vs what pixels were rendered in the bitmap.
            This helps debug display rendering issues.
        </p>
        
        <div class="filter-bar">
            <div class="form-group flex-1 min-width-300 mb-0">
                <label for="device-filter">Select Device</label>
                <select id="device-filter" class="device-filter-select" onchange="loadSnapshots()">
                    <option value="">-- Select a device --</option>
                </select>
            </div>
            
            <div class="form-group flex-1 min-width-150 mb-0">
                <label for="limit-filter">Show</label>
                <select id="limit-filter" onchange="loadSnapshots()">
                    <option value="10">Last 10</option>
                    <option value="25" selected>Last 25</option>
                    <option value="50">Last 50</option>
                    <option value="100">Last 100</option>
                </select>
            </div>
        </div>

        <div id="snapshot-container">
            <div class="empty-state">
                <p>Select a device to view snapshot history</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    let currentDevice = null;

    async function loadDevicesList() {
        try {
            const response = await fetch('/api/devices');
            const data = await response.json();
            
            if (data.devices && data.devices.length > 0) {
                const select = document.getElementById('device-filter');
                data.devices.forEach(device => {
                    const option = document.createElement('option');
                    option.value = device.device_id;
                    option.textContent = `${device.device_id} (${device.board})`;
                    select.appendChild(option);
                });
            }
        } catch (error) {
            console.error('Failed to load devices list:', error);
        }
    }

    async function loadSnapshots() {
        const deviceId = document.getElementById('device-filter').value;
        const limit = document.getElementById('limit-filter').value;
        const container = document.getElementById('snapshot-container');
        
        if (!deviceId) {
            container.innerHTML = `
                <div class="empty-state">
                    <p>Select a device to view snapshot history</p>
                </div>
            `;
            return;
        }
        
        currentDevice = deviceId;
        container.innerHTML = `<div class="empty-state"><p>Loading snapshots...</p></div>`;
        
        try {
            const response = await fetch(`/api/devices/${deviceId}/snapshots?limit=${limit}`);
            const data = await response.json();
            
            if (!data.snapshots || data.snapshots.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <p>No snapshots found for this device</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            data.snapshots.forEach(snapshot => {
                html += renderSnapshot(snapshot);
            });
            
            container.innerHTML = html;
        } catch (error) {
            console.error('Failed to load snapshots:', error);
            container.innerHTML = `
                <div class="empty-state">
                    <p>‚ùå Failed to load snapshots: ${error.message}</p>
                </div>
            `;
        }
    }

    function renderSnapshot(snapshot) {
        const timestamp = new Date(snapshot.timestamp).toLocaleString();
        const rowText = snapshot.row_text || [];
        const bitmap = snapshot.bitmap_data || {};
        
        let rowTextHtml = '<ul class="list-reset">';
        rowText.forEach((text, index) => {
            rowTextHtml += `<li><strong>Row ${index}:</strong> "${text}"</li>`;
        });
        rowTextHtml += '</ul>';
        
        return `
            <div class="snapshot-card">
                <div class="snapshot-card-header">
                    <h3>üì∏ Snapshot #${snapshot.id}</h3>
                    <span class="snapshot-timestamp">${timestamp}</span>
                </div>
                
                <div class="snapshot-grid">
                    <div class="snapshot-section">
                        <h4>üìù Row Text (Sent by Device)</h4>
                        ${rowTextHtml}
                    </div>
                    
                    <div class="snapshot-section">
                        <h4>üé® Bitmap Preview (${bitmap.width || 0}x${bitmap.height || 0})</h4>
                        <div class="bitmap-preview">
                            <canvas id="canvas-${snapshot.id}" class="bitmap-canvas"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    function renderAllBitmaps() {
        const container = document.getElementById('snapshot-container');
        const canvases = container.querySelectorAll('canvas[id^="canvas-"]');
        
        canvases.forEach(canvas => {
            const snapshotId = canvas.id.split('-')[1];
            const snapshot = findSnapshotById(parseInt(snapshotId));
            if (snapshot && snapshot.bitmap_data) {
                renderBitmapToCanvas(canvas.id, snapshot.bitmap_data);
            }
        });
    }

    let cachedSnapshots = [];

    async function loadSnapshots() {
        const deviceId = document.getElementById('device-filter').value;
        const limit = document.getElementById('limit-filter').value;
        const container = document.getElementById('snapshot-container');
        
        if (!deviceId) {
            container.innerHTML = `
                <div class="empty-state">
                    <p>Select a device to view snapshot history</p>
                </div>
            `;
            return;
        }
        
        currentDevice = deviceId;
        container.innerHTML = `<div class="empty-state"><p>Loading snapshots...</p></div>`;
        
        try {
            const response = await fetch(`/api/devices/${deviceId}/snapshots?limit=${limit}`);
            const data = await response.json();
            
            if (!data.snapshots || data.snapshots.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <p>No snapshots found for this device</p>
                    </div>
                `;
                return;
            }
            
            cachedSnapshots = data.snapshots;
            
            let html = '';
            data.snapshots.forEach(snapshot => {
                html += renderSnapshot(snapshot);
            });
            
            container.innerHTML = html;
            
            setTimeout(() => {
                data.snapshots.forEach(snapshot => {
                    if (snapshot.bitmap_data) {
                        renderBitmapToCanvas(`canvas-${snapshot.id}`, snapshot.bitmap_data);
                    }
                });
            }, 100);
            
        } catch (error) {
            console.error('Failed to load snapshots:', error);
            container.innerHTML = `
                <div class="empty-state">
                    <p>‚ùå Failed to load snapshots: ${error.message}</p>
                </div>
            `;
        }
    }

    function findSnapshotById(id) {
        return cachedSnapshots.find(s => s.id === id);
    }

    function renderBitmapToCanvas(canvasId, bitmapData) {
        const canvas = document.getElementById(canvasId);
        // Support all three formats
        const monoData = bitmapData.mono || bitmapData.pixels;
        const colorData = bitmapData.color;
        
        if (!canvas || (!monoData && !colorData)) return;
        
        try {
            const width = bitmapData.width || 16;
            const height = bitmapData.height || 16;
            
            // Determine rendering mode
            const isColorMode = !!colorData;
            let pixelData = null;
            let colorPixelData = null;
            
            if (isColorMode) {
                colorPixelData = atob(colorData);
            } else {
                pixelData = atob(monoData);
            }
            
            // Get mono color from monoColor [R, G, B, brightness] or default to white
            let monoR = 255, monoG = 255, monoB = 255;
            if (bitmapData.monoColor && bitmapData.monoColor.length >= 3) {
                monoR = bitmapData.monoColor[0];
                monoG = bitmapData.monoColor[1];
                monoB = bitmapData.monoColor[2];
                if (bitmapData.monoColor.length >= 4) {
                    const brightness = bitmapData.monoColor[3] / 255;
                    monoR = Math.round(monoR * brightness);
                    monoG = Math.round(monoG * brightness);
                    monoB = Math.round(monoB * brightness);
                }
            }
            
            canvas.width = width;
            canvas.height = height;
            
            const ctx = canvas.getContext('2d');
            const imageData = ctx.createImageData(width, height);
            
            let pixelIndex = 0;
            for (let y = 0; y < height; y++) {
                for (let x = 0; x < width; x++) {
                    const i = (y * width + x) * 4;
                    
                    if (isColorMode) {
                        // Full color mode: read 4 bytes per pixel (R, G, B, brightness)
                        const colorByteIndex = pixelIndex * 4;
                        const r = colorPixelData.charCodeAt(colorByteIndex) || 0;
                        const g = colorPixelData.charCodeAt(colorByteIndex + 1) || 0;
                        const b = colorPixelData.charCodeAt(colorByteIndex + 2) || 0;
                        const brightness = (colorPixelData.charCodeAt(colorByteIndex + 3) || 255) / 255;
                        
                        imageData.data[i] = Math.round(r * brightness);
                        imageData.data[i + 1] = Math.round(g * brightness);
                        imageData.data[i + 2] = Math.round(b * brightness);
                        imageData.data[i + 3] = 255;
                    } else {
                        // Mono mode: bit-packed
                        const byteIndex = Math.floor(pixelIndex / 8);
                        const bitIndex = pixelIndex % 8;
                        const byte = pixelData.charCodeAt(byteIndex) || 0;
                        const isOn = (byte & (1 << bitIndex)) !== 0;
                        
                        if (isOn) {
                            imageData.data[i] = monoR;
                            imageData.data[i + 1] = monoG;
                            imageData.data[i + 2] = monoB;
                            imageData.data[i + 3] = 255;
                        } else {
                            imageData.data[i] = 0;
                            imageData.data[i + 1] = 0;
                            imageData.data[i + 2] = 0;
                            imageData.data[i + 3] = 255;
                        }
                    }
                    
                    pixelIndex++;
                }
            }
            
            ctx.putImageData(imageData, 0, 0);
            
            canvas.style.width = `${Math.min(width * 4, 400)}px`;
            canvas.style.height = 'auto';
            
        } catch (error) {
            console.error('Failed to render bitmap:', error);
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        loadDevicesList();
    });
</script>
{% endblock %}
