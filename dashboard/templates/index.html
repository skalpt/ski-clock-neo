{% extends "base.html" %}

{% block title %}Ski Clock Neo - Firmware Dashboard{% endblock %}

{% block extra_head %}
<script type="module" src="https://unpkg.com/esp-web-tools@10/dist/web/install-button.js?module"></script>
{% endblock %}

{% block content %}
<div class="container">
    <div class="header-bar">
        <div class="header-content">
            <h1>‚õ∑Ô∏è Ski Clock Neo</h1>
            <p class="subtitle">Firmware Dashboard & Device Monitoring</p>
        </div>
        <a href="/logout" class="logout-btn">Logout</a>
    </div>

    <div class="card">
        <h2>üì° Live Devices</h2>
        <div id="stats-container"></div>
        <div id="devices-container">
            <div class="empty-state">
                <p>Loading device data...</p>
            </div>
        </div>
    </div>

    <div class="card">
        <h2>üì¶ Firmware Versions</h2>
        <table class="firmware-table" id="firmware-table">
            <thead>
                <tr>
                    <th>Platform</th>
                    <th>Filename</th>
                    <th>Version</th>
                    <th>Flash to Device</th>
                </tr>
            </thead>
            <tbody id="firmware-body">
                <tr>
                    <td colspan="3" style="text-align: center; color: #999;">Loading...</td>
                </tr>
            </tbody>
        </table>
    </div>

    <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h2>üìä OTA Update Statistics</h2>
            <a href="/ota-history" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 8px 16px; border-radius: 6px; text-decoration: none; font-weight: bold;">
                View Full History ‚Üí
            </a>
        </div>
        <div id="ota-stats-container">
            <div class="empty-state">
                <p>Loading OTA statistics...</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // HTML escape function to prevent XSS attacks
    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Check if IP address is IPv4 (for clickable links)
    function isIPv4(ip) {
        // Simple check: IPv4 has dots, IPv6 has colons
        return ip && !ip.includes(':');
    }

    async function loadOTAStats() {
        try {
            const response = await fetch('/api/ota-stats');
            const data = await response.json();
            
            const container = document.getElementById('ota-stats-container');
            container.innerHTML = `
                <div class="ota-stats-grid">
                    <div class="ota-stat-card">
                        <div class="label">Total Updates</div>
                        <div class="value">${data.total_updates}</div>
                    </div>
                    <div class="ota-stat-card success">
                        <div class="label">Successful</div>
                        <div class="value">${data.success_count}</div>
                    </div>
                    <div class="ota-stat-card failed">
                        <div class="label">Failed</div>
                        <div class="value">${data.failed_count}</div>
                    </div>
                    <div class="ota-stat-card in-progress">
                        <div class="label">In Progress</div>
                        <div class="value">${data.in_progress_count}</div>
                    </div>
                    <div class="ota-stat-card">
                        <div class="label">Success Rate</div>
                        <div class="value">${data.success_rate}%</div>
                    </div>
                    <div class="ota-stat-card">
                        <div class="label">Avg Duration</div>
                        <div class="value">${data.avg_duration_seconds}s</div>
                    </div>
                    <div class="ota-stat-card">
                        <div class="label">Last 7 Days</div>
                        <div class="value">${data.recent_updates_7days}</div>
                    </div>
                    <div class="ota-stat-card failed">
                        <div class="label">Failed (24h)</div>
                        <div class="value">${data.failed_devices_24h}</div>
                    </div>
                </div>
            `;
        } catch (error) {
            console.error('Failed to load OTA stats:', error);
            const container = document.getElementById('ota-stats-container');
            container.innerHTML = `
                <div class="empty-state">
                    <p>No OTA update data available yet</p>
                </div>
            `;
        }
    }

    async function loadDevices() {
        try {
            const [devicesResponse, progressResponse] = await Promise.all([
                fetch('/api/devices'),
                fetch('/api/ota-progress')
            ]);
            
            const data = await devicesResponse.json();
            const otaProgress = await progressResponse.json();
            
            const container = document.getElementById('devices-container');
            const statsContainer = document.getElementById('stats-container');
            
            if (data.count === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <p>${data.mqtt_enabled ? 'No devices connected yet' : 'MQTT monitoring not configured'}</p>
                        <p style="font-size: 0.9rem; margin-top: 10px; color: #999;">
                            ${data.mqtt_enabled ? 'Devices will appear here when they send heartbeats' : 'Configure MQTT credentials to enable device monitoring'}
                        </p>
                    </div>
                `;
                statsContainer.innerHTML = '';
                return;
            }

            // Calculate degraded count
            const degradedCount = data.devices.filter(d => d.status === 'degraded').length;
            
            // Stats bar
            statsContainer.innerHTML = `
                <div class="stats-bar">
                    <div>Total: <span>${data.count}</span></div>
                    <div>üü¢ Online: <span>${data.online_count - degradedCount}</span></div>
                    ${degradedCount > 0 ? `<div>üü† Degraded: <span>${degradedCount}</span></div>` : ''}
                    <div>üî¥ Offline: <span>${data.offline_count}</span></div>
                </div>
            `;

            const devicesHtml = data.devices.map(device => {
                // Escape all user-supplied data to prevent XSS
                const safeDeviceId = escapeHtml(device.device_id);
                const safeBoard = escapeHtml(device.board);
                const safeVersion = escapeHtml(device.version);
                const safeSsid = escapeHtml(device.ssid);
                const safeIpAddress = escapeHtml(device.ip_address);
                
                // Check if this device has an OTA update in progress
                const ota = otaProgress[device.device_id];
                const otaHtml = ota ? `
                    <div class="ota-progress">
                        <div class="ota-progress-label">
                            üîÑ Updating: ${escapeHtml(ota.old_version || 'Unknown')} ‚Üí ${escapeHtml(ota.new_version)}
                        </div>
                        <div class="ota-progress-bar">
                            <div class="ota-progress-fill" style="width: ${ota.progress}%"></div>
                            <div class="ota-progress-text">${ota.progress}%</div>
                        </div>
                    </div>
                ` : '';
                
                // Determine CSS class based on status
                const statusClass = device.status === 'offline' ? 'offline' : device.status === 'degraded' ? 'degraded' : '';
                const statusText = device.status.charAt(0).toUpperCase() + device.status.slice(1);
                
                return `
                <div class="device-card ${statusClass}">
                    <div class="device-header">
                        <div>
                            <span class="status ${statusClass}"></span>
                            ${safeDeviceId}
                        </div>
                        <span class="badge">${safeBoard}</span>
                    </div>
                    <div class="device-info">
                        <div><strong>Status:</strong> ${statusText}${device.status === 'degraded' ? ' (unstable connection)' : ''}</div>
                        <div><strong>Version:</strong> ${safeVersion}</div>
                        <div><strong>Uptime:</strong> ${formatUptime(device.uptime)}</div>
                        ${device.ssid ? `<div><strong>WiFi Network:</strong> ${safeSsid}</div>` : ''}
                        ${device.ip_address ? `<div><strong>IP Address:</strong> ${device.online && isIPv4(device.ip_address) ? `<a href="http://${encodeURIComponent(device.ip_address)}/" target="_blank" rel="noopener noreferrer" style="color: white; text-decoration: none;" title="Open AutoConnect page (only works if you're on the same network)">${safeIpAddress}</a>` : safeIpAddress}</div>` : ''}
                        <div><strong>WiFi Signal:</strong> ${getSignalStrengthIcon(device.rssi)}${device.rssi} dBm</div>
                        <div><strong>Free Memory:</strong> ${(device.free_heap / 1024).toFixed(1)} KB</div>
                        <div><strong>Last Seen:</strong> <span class="live-timestamp" data-timestamp="${escapeHtml(device.last_seen)}">${formatTimestamp(device.last_seen)}</span></div>
                        <div><strong>First Seen:</strong> ${new Date(device.first_seen).toLocaleString()}</div>
                    </div>
                    ${otaHtml}
                    <div class="device-actions">
                        <button class="device-btn rollback-btn" data-device-id="${safeDeviceId}" data-action="rollback" ${device.status === 'offline' ? 'disabled title="Device must be online"' : ''}>
                            ‚èÆÔ∏è Rollback
                        </button>
                        <button class="device-btn restart-btn" data-device-id="${safeDeviceId}" data-action="restart" ${device.status === 'offline' ? 'disabled title="Device must be online"' : ''}>
                            üîÑ Restart
                        </button>
                        <button class="device-btn delete-btn" data-device-id="${safeDeviceId}" data-action="delete">
                            üóëÔ∏è Remove
                        </button>
                    </div>
                </div>
            `;
            }).join('');

            container.innerHTML = `<div class="devices-grid">${devicesHtml}</div>`;
            
            // Attach event listeners to all device action buttons
            document.querySelectorAll('.device-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const deviceId = btn.getAttribute('data-device-id');
                    const action = btn.getAttribute('data-action');
                    
                    if (action === 'delete') {
                        deleteDevice(deviceId);
                    } else if (action === 'rollback') {
                        rollbackDevice(deviceId);
                    } else if (action === 'restart') {
                        restartDevice(deviceId);
                    }
                });
            });
        } catch (error) {
            console.error('Failed to load devices:', error);
        }
    }

    async function deleteDevice(deviceId) {
        if (!confirm(`Are you sure you want to remove device ${deviceId}?\n\nThis will permanently delete it from the database.`)) {
            return;
        }
        
        try {
            const response = await fetch(`/api/devices/${deviceId}`, {
                method: 'DELETE'
            });
            
            if (response.ok) {
                alert('Device removed successfully');
                loadDevices();
            } else {
                const error = await response.json();
                alert(`Failed to remove device: ${error.error}`);
            }
        } catch (error) {
            console.error('Failed to delete device:', error);
            alert('Failed to remove device');
        }
    }

    async function rollbackDevice(deviceId) {
        if (!confirm(`Send rollback command to ${deviceId}?\n\nThis will instruct the device to restore its previous firmware version.`)) {
            return;
        }
        
        try {
            const response = await fetch(`/api/devices/${deviceId}/rollback`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });
            
            const data = await response.json();
            
            if (response.ok) {
                alert(data.message || 'Rollback command sent successfully');
            } else {
                alert(`Failed to send rollback command: ${data.error}`);
            }
        } catch (error) {
            console.error('Failed to send rollback command:', error);
            alert('Failed to send rollback command');
        }
    }

    async function restartDevice(deviceId) {
        if (!confirm(`Send restart command to ${deviceId}?\n\nThis will reboot the device.`)) {
            return;
        }
        
        try {
            const response = await fetch(`/api/devices/${deviceId}/restart`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });
            
            const data = await response.json();
            
            if (response.ok) {
                alert(data.message || 'Restart command sent successfully');
            } else {
                alert(`Failed to send restart command: ${data.error}`);
            }
        } catch (error) {
            console.error('Failed to send restart command:', error);
            alert('Failed to send restart command');
        }
    }

    async function loadFirmware() {
        try {
            const response = await fetch('/api/status');
            const data = await response.json();
            const tbody = document.getElementById('firmware-body');
            
            const rows = Object.entries(data.firmwares)
                .filter(([_, fw]) => fw !== null)
                .map(([platform, fw]) => {
                    // Check if user has download permission
                    const canDownload = fw.can_download !== false;
                    const downloadUrl = fw.public_download_url || fw.download_url || '#';
                    const supportsFullFlash = fw.supports_full_flash || false;
                    
                    // Render different content based on permission
                    if (canDownload) {
                        // Build flash button with dropdown for full flash if available
                        let flashButtons;
                        
                        if (supportsFullFlash) {
                            // Mode-switcher button with dropdown for Quick/Full Flash
                            flashButtons = `
                                <div class="split-button-group" data-platform="${platform}">
                                    <esp-web-install-button id="flash-installer-${platform}" manifest="/firmware/manifest/${platform}.json?mode=quick">
                                        <button slot="activate" class="flash-btn flash-btn-main" id="flash-btn-${platform}">
                                            <span class="flash-btn-icon">‚ö°</span>
                                            <span class="flash-btn-text">Quick Flash</span>
                                        </button>
                                    </esp-web-install-button>
                                    <button class="flash-btn flash-btn-dropdown" onclick="toggleFlashDropdown(event, '${platform}')" title="Flash options">‚ñº</button>
                                    <div class="flash-dropdown" id="flash-dropdown-${platform}">
                                        <button class="flash-dropdown-item" onclick="switchFlashMode('${platform}', 'full')" data-mode="full">
                                            <span class="flash-btn-icon">üîß</span> Full Flash (Recovery)
                                        </button>
                                        <button class="flash-dropdown-item" onclick="switchFlashMode('${platform}', 'quick')" data-mode="quick" style="display: none;">
                                            <span class="flash-btn-icon">‚ö°</span> Quick Flash
                                        </button>
                                    </div>
                                </div>
                            `;
                        } else {
                            // Single Quick Flash button (same width as split buttons)
                            flashButtons = `
                                <div class="split-button-group">
                                    <esp-web-install-button manifest="/firmware/manifest/${platform}.json?mode=quick">
                                        <button slot="activate" class="flash-btn flash-btn-main flash-btn-single">
                                            <span class="flash-btn-icon">‚ö°</span>
                                            <span class="flash-btn-text">Quick Flash</span>
                                        </button>
                                    </esp-web-install-button>
                                </div>
                            `;
                        }
                        
                        return `
                            <tr>
                                <td><strong>${platform.toUpperCase()}</strong></td>
                                <td><a href="${downloadUrl}" style="color: #667eea; text-decoration: none;">${escapeHtml(fw.filename || 'Unknown')}</a></td>
                                <td>${escapeHtml(fw.version || 'Unknown')}</td>
                                <td>
                                    ${flashButtons}
                                </td>
                            </tr>
                        `;
                    } else {
                        return `
                            <tr style="opacity: 0.5;">
                                <td><strong>${platform.toUpperCase()}</strong></td>
                                <td>${escapeHtml(fw.filename || 'Unknown')}</td>
                                <td>${escapeHtml(fw.version || 'Unknown')}</td>
                                <td><span style="color: #999;">No Permission</span></td>
                            </tr>
                        `;
                    }
                }).join('');

            tbody.innerHTML = rows || '<tr><td colspan="4" style="text-align: center; color: #999;">No firmware uploaded yet</td></tr>';
        } catch (error) {
            console.error('Failed to load firmware:', error);
        }
    }

    function formatUptime(seconds) {
        const hours = Math.floor(seconds / 3600);
        const minutes = Math.floor((seconds % 3600) / 60);
        return `${hours}h ${minutes}m`;
    }

    function getSignalStrengthIcon(rssi) {
        // RSSI to signal strength conversion:
        // Excellent: > -50 dBm (4 bars)
        // Good: -50 to -60 dBm (3 bars)
        // Fair: -60 to -70 dBm (2 bars)
        // Poor: < -70 dBm (1 bar)
        let bars = 1;
        if (rssi > -50) bars = 4;
        else if (rssi > -60) bars = 3;
        else if (rssi > -70) bars = 2;
        
        return `
            <span class="signal-icon">
                <span class="bar ${bars >= 1 ? 'active' : ''}"></span>
                <span class="bar ${bars >= 2 ? 'active' : ''}"></span>
                <span class="bar ${bars >= 3 ? 'active' : ''}"></span>
                <span class="bar ${bars >= 4 ? 'active' : ''}"></span>
            </span>
        `;
    }

    function formatTimestamp(timestamp) {
        const date = new Date(timestamp);
        const now = new Date();
        const diffSeconds = Math.floor((now - date) / 1000);
        
        if (diffSeconds < 60) return `${diffSeconds}s ago`;
        if (diffSeconds < 3600) return `${Math.floor(diffSeconds / 60)}m ago`;
        return date.toLocaleTimeString();
    }

    function updateLiveTimestamps() {
        // Update all live timestamp elements
        const timestamps = document.querySelectorAll('.live-timestamp');
        timestamps.forEach(elem => {
            const timestamp = elem.getAttribute('data-timestamp');
            if (timestamp) {
                elem.textContent = formatTimestamp(timestamp);
            }
        });
    }

    function toggleFlashDropdown(event, platform) {
        event.stopPropagation();
        const dropdown = document.getElementById(`flash-dropdown-${platform}`);
        const allDropdowns = document.querySelectorAll('.flash-dropdown');
        
        // Close all other dropdowns
        allDropdowns.forEach(d => {
            if (d !== dropdown) {
                d.classList.remove('show');
            }
        });
        
        // Toggle this dropdown
        dropdown.classList.toggle('show');
    }

    function switchFlashMode(platform, newMode) {
        // Get the installer element and button
        const installer = document.getElementById(`flash-installer-${platform}`);
        const button = document.getElementById(`flash-btn-${platform}`);
        const dropdown = document.getElementById(`flash-dropdown-${platform}`);
        
        // Update manifest URL
        installer.setAttribute('manifest', `/firmware/manifest/${platform}.json?mode=${newMode}`);
        
        // Update button text and icon based on mode
        const iconSpan = button.querySelector('.flash-btn-icon');
        const textSpan = button.querySelector('.flash-btn-text');
        
        if (newMode === 'full') {
            iconSpan.textContent = 'üîß';
            textSpan.textContent = 'Full Flash';
        } else {
            iconSpan.textContent = '‚ö°';
            textSpan.textContent = 'Quick Flash';
        }
        
        // Toggle dropdown items visibility (show opposite mode)
        const dropdownItems = dropdown.querySelectorAll('.flash-dropdown-item');
        dropdownItems.forEach(item => {
            const itemMode = item.getAttribute('data-mode');
            item.style.display = itemMode === newMode ? 'none' : 'block';
        });
        
        // Close the dropdown
        dropdown.classList.remove('show');
    }

    // Close dropdowns when clicking outside
    document.addEventListener('click', (event) => {
        if (!event.target.closest('.split-button-group')) {
            document.querySelectorAll('.flash-dropdown').forEach(d => {
                d.classList.remove('show');
            });
        }
    });

    // Handle tab visibility changes to recalculate after backgrounding
    document.addEventListener('visibilitychange', () => {
        if (!document.hidden) {
            // Tab is now visible - recalculate all timestamps immediately
            updateLiveTimestamps();
        }
    });

    // Initial load
    loadOTAStats();
    loadDevices();
    loadFirmware();

    // Update live timestamps every second for smooth counting
    setInterval(updateLiveTimestamps, 1000);
    
    // Refresh OTA stats every 30 seconds
    setInterval(loadOTAStats, 30000);

    // Refresh data from server every 10 seconds
    setInterval(loadDevices, 10000);
    setInterval(loadFirmware, 60000);
</script>
{% endblock %}
