{% extends "base.html" %}

{% block title %}OTA Update History - Ski Clock Neo{% endblock %}

{% block content %}
<div class="container">
    <div class="header-bar">
        <div class="header-content">
            <h1>‚õ∑Ô∏è Ski Clock Neo</h1>
            <p class="subtitle">OTA Update History</p>
        </div>
        <a href="/" class="back-link">‚Üê Back to Dashboard</a>
    </div>

    <div class="card">
        <h2>üìú Firmware Update Log</h2>
        
        <div class="filter-bar">
            <div class="form-group" style="flex: 1; min-width: 200px; margin-bottom: 0;">
                <label for="device-filter">Device</label>
                <select id="device-filter" class="device-filter-select">
                    <option value="">All Devices</option>
                </select>
            </div>
            
            <div class="form-group" style="flex: 1; min-width: 150px; margin-bottom: 0;">
                <label for="status-filter">Status</label>
                <select id="status-filter">
                    <option value="">All Status</option>
                    <option value="success">Success</option>
                    <option value="failed">Failed</option>
                    <option value="in-progress">In Progress</option>
                </select>
            </div>
            
            <div class="form-group" style="flex: 1; min-width: 200px; margin-bottom: 0;">
                <label for="date-from">From Date</label>
                <input type="datetime-local" id="date-from" class="date-input">
            </div>
            
            <div class="form-group" style="flex: 1; min-width: 200px; margin-bottom: 0;">
                <label for="date-to">To Date</label>
                <input type="datetime-local" id="date-to" class="date-input">
            </div>
            
            <div style="display: flex; align-items: flex-end; gap: 10px;">
                <button onclick="applyFilters()">Apply Filters</button>
                <button onclick="clearFilters()" style="background: rgba(255,255,255,0.3);">Clear</button>
            </div>
        </div>

        <div id="ota-history-container">
            <div class="empty-state">
                <p>Loading OTA history...</p>
            </div>
        </div>
        
        <div class="pagination" id="pagination-container"></div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    let currentPage = 1;
    const pageSize = 50;
    let currentFilters = {};
    let allDevices = [];

    async function loadDevicesList() {
        try {
            const response = await fetch('/api/devices');
            const data = await response.json();
            
            if (data.devices && data.devices.length > 0) {
                allDevices = data.devices.map(d => d.device_id).sort();
                const select = document.getElementById('device-filter');
                allDevices.forEach(deviceId => {
                    const option = document.createElement('option');
                    option.value = deviceId;
                    option.textContent = deviceId;
                    select.appendChild(option);
                });
            }
        } catch (error) {
            console.error('Failed to load devices list:', error);
        }
    }

    async function loadOTAHistory(page = 1) {
        try {
            let url = `/api/ota-logs?limit=${pageSize}&offset=${(page - 1) * pageSize}`;
            
            if (currentFilters.device_id) {
                url += `&device_id=${encodeURIComponent(currentFilters.device_id)}`;
            }
            if (currentFilters.status) {
                url += `&status=${encodeURIComponent(currentFilters.status)}`;
            }
            if (currentFilters.start_date) {
                url += `&start_date=${encodeURIComponent(currentFilters.start_date)}`;
            }
            if (currentFilters.end_date) {
                url += `&end_date=${encodeURIComponent(currentFilters.end_date)}`;
            }
            
            const response = await fetch(url);
            const data = await response.json();
            
            const container = document.getElementById('ota-history-container');
            
            if (!data.logs || data.logs.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <p>No OTA updates found</p>
                    </div>
                `;
                document.getElementById('pagination-container').innerHTML = '';
                return;
            }
            
            const tableHtml = `
                <table class="ota-history-table">
                    <thead>
                        <tr>
                            <th>Timestamp</th>
                            <th>Device ID</th>
                            <th>Platform</th>
                            <th>Old Version</th>
                            <th>New Version</th>
                            <th>Progress</th>
                            <th>Status</th>
                            <th>Duration</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${data.logs.map(log => {
                            const statusClass = log.status === 'success' ? 'success' : log.status === 'failed' ? 'failed' : 'in-progress';
                            const progressBar = log.status === 'in-progress' ? `
                                <div class="progress-bar-mini">
                                    <div class="fill" style="width: ${log.download_progress}%"></div>
                                </div>
                            ` : `${log.download_progress}%`;
                            
                            const duration = log.duration_seconds ? `${log.duration_seconds}s` : '-';
                            
                            return `
                                <tr>
                                    <td>${new Date(log.started_at).toLocaleString()}</td>
                                    <td>${escapeHtml(log.device_id)}</td>
                                    <td>${escapeHtml(log.platform || '-')}</td>
                                    <td>${escapeHtml(log.old_version || '-')}</td>
                                    <td>${escapeHtml(log.new_version || '-')}</td>
                                    <td>${progressBar}</td>
                                    <td><span class="status-badge ${statusClass}">${log.status}</span></td>
                                    <td>${duration}</td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
            
            container.innerHTML = tableHtml;
            
            // Update pagination
            updatePagination(data.total, page);
            
        } catch (error) {
            console.error('Failed to load OTA history:', error);
            const container = document.getElementById('ota-history-container');
            container.innerHTML = `
                <div class="empty-state">
                    <p>Failed to load OTA history</p>
                </div>
            `;
        }
    }

    function updatePagination(total, currentPage) {
        const totalPages = Math.ceil(total / pageSize);
        
        if (totalPages <= 1) {
            document.getElementById('pagination-container').innerHTML = '';
            return;
        }
        
        let paginationHtml = `
            <button onclick="goToPage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>
                ‚Üê Previous
            </button>
            <span style="padding: 8px 16px; font-weight: bold;">
                Page ${currentPage} of ${totalPages}
            </span>
            <button onclick="goToPage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>
                Next ‚Üí
            </button>
        `;
        
        document.getElementById('pagination-container').innerHTML = paginationHtml;
    }

    function goToPage(page) {
        currentPage = page;
        loadOTAHistory(page);
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function applyFilters() {
        const deviceId = document.getElementById('device-filter').value;
        const status = document.getElementById('status-filter').value;
        const dateFrom = document.getElementById('date-from').value;
        const dateTo = document.getElementById('date-to').value;
        
        currentFilters = {};
        if (deviceId) currentFilters.device_id = deviceId;
        if (status) currentFilters.status = status;
        if (dateFrom) currentFilters.start_date = new Date(dateFrom).toISOString();
        if (dateTo) currentFilters.end_date = new Date(dateTo).toISOString();
        
        currentPage = 1;
        loadOTAHistory(1);
    }

    function clearFilters() {
        document.getElementById('device-filter').value = '';
        document.getElementById('status-filter').value = '';
        document.getElementById('date-from').value = '';
        document.getElementById('date-to').value = '';
        currentFilters = {};
        currentPage = 1;
        loadOTAHistory(1);
    }

    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Initial load
    loadDevicesList();
    loadOTAHistory(1);
    
    // Auto-refresh every 30 seconds
    setInterval(() => loadOTAHistory(currentPage), 30000);
</script>
{% endblock %}
